{% extends "template.html" %}
{% block content %}
    <h2 id="product-name"></h2>
    <form method="post" enctype="multipart/form-data" id="ad-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_product_name">Nom del producte:</label>
            <input type="text" name="product_name" id="id_product_name" class="form-control"
                   placeholder="Nom del producte">
        </div>
        <div class="form-group">
            <label for="id_description">Descripció del producte:</label>
            <input type="text" name="description" id="id_description" class="form-control"
                   placeholder="Descripció del producte">
        </div>
        <div class="form-group">
            <label for="id_price">Preu:</label>
            <input type="text" name="price" id="id_price" class="form-control" placeholder="0.00">
        </div>
        <button type="submit" class="btn btn-primary mt-2">Editar anunci</button>
    </form>

    <script>
        var logged_user;
        if (localStorage.getItem('token')) {
            $.ajax({
                url: 'http://127.0.0.1:8000/api/retrieve-user',
                method: 'GET',
                async: false,
                headers: {
                    'Authorization': 'Token ' + localStorage.getItem('token')
                },
                success: function (response) {
                    logged_user = response
                    console.log(response)
                },
                error: function (xhr, textStatus, errorThrown) {
                    // Handle the error
                    console.error('Error:', errorThrown);
                }
            });
        }

        $(document).ready(function () {
            var url = window.location.href;
            var id = url.split("/")[4];

            $.ajax({
                url: '/api/ads/' + id + '/?format=json',
                method: 'GET',
                dataType: 'json',
                success: function (ad) {
                    fillInputs(ad);
                },
                error: function () {
                    console.log("No s'han pogut obtenir les dades de l'anunci");
                    $('#content').text("No s'han pogut obtenir les dades de l'anunci");
                }
            });
        });

        function fillInputs(ad) {
            $('#product-name').text("Editar l'anunci: " + ad.product_name)
            $('#id_product_name').val(ad.product_name)
            $('#id_description').val(ad.description)
            $('#id_price').val(ad.price)
        }

        $('#ad-form').submit(function (e) {
            e.preventDefault();

            var formData = new FormData(this);
            var id = window.location.href.split("/")[4];

            $.ajax({
                url: '/api/ads/' + id + '/',
                method: 'PUT',
                data: formData,
                headers: {
                    'Authorization': 'Token ' + localStorage.getItem('token'),
                    'X-CSRFToken': $.cookie("csrftoken")
                },
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log('Anunci editat amb èxit');
                    window.location.href = '/ad/' + id;
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error('Error:', errorThrown);
                }
            });
        });

    </script>
{% endblock %}